{# Leaf tenant IGMP snooping #}
{% set igmp_snooping = namespace() %}
{% set igmp_snooping.configured = false %}
{% if leaf.igmp_snooping_enabled == true %}
{% set igmp_snooping.configured = true %}
{% endif %}
{% for tenant in tenants | arista.avd.natural_sort if tenant in leaf.filter_tenants or "all" in leaf.filter_tenants %}
{%     if tenants[tenant].vrfs is defined %}
{%         for vrf in tenants[tenant].vrfs | arista.avd.natural_sort if leaf.vrfs is not none and vrf in leaf.vrfs %}
{%             for svi in tenants[tenant].vrfs[vrf].svis | arista.avd.natural_sort if leaf.svis is not none and svi in leaf.svis %}
{%                  if tenants[tenant].vrfs[vrf].svis[svi].igmp_snooping is defined %}
{%                      set igmp_snooping.configured = true %}
{%                  endif %}
{%             endfor %}
{%         endfor %}
{%     endif %}
{%     if tenants[tenant].l2vlans is defined %}
{%         for l2vlan in tenants[tenant].l2vlans | arista.avd.natural_sort  %}
{%             if tenants[tenant].l2vlans[l2vlan].igmp_snooping is defined %}
{%                set igmp_snooping.configured = true %}
{%             endif %}
{%         endfor %}
{%     endif %}
{% endfor %}
  globally_enabled: {{ leaf.igmp_snooping_enabled }}
{% if igmp_snooping.configured == true %}
  vlans:
{# ---------------------------- #}
{# SVI & L3VLANs services       #}
{# ---------------------------- #}
{%      for tenant in tenants | arista.avd.natural_sort if tenant in leaf.filter_tenants or "all" in leaf.filter_tenants %}
## {{ tenant }} ##
{%          if tenants[tenant].vrfs is defined %}
{%              for vrf in tenants[tenant].vrfs | arista.avd.natural_sort if leaf.vrfs is not none and vrf in leaf.vrfs %}
{# Tenant VLANs w/SVIs #}
{%                  for svi in tenants[tenant].vrfs[vrf].svis | arista.avd.natural_sort if leaf.svis is not none and svi in leaf.svis %}
{%                      if tenants[tenant].vrfs[vrf].svis[svi].igmp_snooping_enabled is defined %}
{%                          if tenants[tenant].vrfs[vrf].svis[svi].igmp_snooping_enabled == false and leaf.igmp_snooping_enabled == true %}
    {{ svi|int }}:
      enabled: false
{%                          endif %}
{%                      endif %}
{%                  endfor %}
{%              endfor %}
{%          endif %}
{# ---------------------------- #}
{# L2VLANs services             #}
{# ---------------------------- #}
{%          if tenants[tenant].l2vlans is defined %}
{%              for l2vlan in tenants[tenant].l2vlans | arista.avd.natural_sort %}
{%                  if tenants[tenant].l2vlans[l2vlan].igmp_snooping_enabled is defined %}
{%                      if tenants[tenant].l2vlans[l2vlan].igmp_snooping_enabled == false and leaf.igmp_snooping_enabled == true %}
    {{ l2vlan|int }}:
      enabled: false
{%                      endif %}
{%                  endif %}
{%              endfor %}
{%          endif %}
{%      endfor %}
{% endif %}
